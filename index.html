<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Family Safety - Location Sharing</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: #0f172a;
        min-height: 100vh;
        color: #f8fafc;
        line-height: 1.6;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        color: #f8fafc;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.8;
        color: #cbd5e1;
      }

      .card {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 24px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
      }

      .login-section {
        max-width: 420px;
        margin: 0 auto;
      }

      .form-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #e2e8f0;
        font-size: 14px;
      }

      input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #475569;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #0f172a;
        color: #f8fafc;
      }

      input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      input::placeholder {
        color: #64748b;
      }

      .btn {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 14px 28px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-bottom: 12px;
        position: relative;
        overflow: hidden;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-secondary {
        background: #475569;
        color: #f8fafc;
      }

      .btn-secondary:hover {
        background: #64748b;
        box-shadow: 0 8px 25px rgba(71, 85, 105, 0.4);
      }

      .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .btn-danger:hover {
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      .btn-success:hover {
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      }

      .family-members {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 24px;
        margin-top: 24px;
      }

      .member-card {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border-left: 4px solid #6366f1;
        transition: all 0.3s ease;
      }

      .member-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }

      .member-info h3 {
        color: #f8fafc;
        margin-bottom: 12px;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .member-status {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
      }

      .status-online {
        background: #10b981;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
      }

      .status-offline {
        background: #ef4444;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
      }

      .location-info {
        color: #94a3b8;
        font-size: 14px;
        margin-bottom: 16px;
      }

      .permission-section {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 24px;
        margin: 24px 0;
      }

      .permission-section h3 {
        color: #f8fafc;
        margin-bottom: 16px;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .permission-text {
        color: #cbd5e1;
        margin-bottom: 16px;
        line-height: 1.6;
      }

      .your-info {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border: 1px solid #6366f1;
        color: #f8fafc;
      }

      .your-info h3 {
        color: #f8fafc;
      }

      .hidden {
        display: none;
      }

      .error {
        color: #f87171;
        font-size: 14px;
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(248, 113, 113, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(248, 113, 113, 0.2);
      }

      .success {
        color: #34d399;
        font-size: 14px;
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(52, 211, 153, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(52, 211, 153, 0.2);
      }

      .map-container {
        height: 320px;
        background: #0f172a;
        border-radius: 12px;
        margin-top: 16px;
        border: 1px solid #334155;
        overflow: hidden;
        position: relative;
      }

      .custom-marker {
        background: #ef4444;
        border: 3px solid #f8fafc;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }

      .location-sharing-status {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 12px;
        padding: 16px;
        margin: 16px 0;
      }

      .sharing-active {
        background: rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.3);
      }

      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      .btn:focus-visible {
        outline: 2px solid #6366f1;
        outline-offset: 2px;
      }

      .storage-notice {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
      }

      .storage-notice h3 {
        color: #60a5fa;
        font-size: 1rem;
        margin-bottom: 8px;
      }

      .storage-notice p {
        color: #cbd5e1;
        font-size: 14px;
        line-height: 1.5;
      }

      @media (max-width: 768px) {
        .container {
          padding: 16px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .family-members {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Family Safety</h1>
        <p>Keep your family connected and safe</p>
      </div>

      <!-- Storage Notice -->
      <div class="storage-notice">
        <h3>📱 Cross-Device Family Sharing</h3>
        <p>Family data is stored using GitHub Gists for cross-device access. When you create a family, you'll get a Family ID that you can share with other family members to join from different devices.</p>
      </div>

      <!-- Login Section -->
      <div id="loginSection" class="card login-section">
        <div id="loginForm">
          <h2 style="text-align: center; margin-bottom: 25px">
            Family Account Access
          </h2>
          <div class="form-group">
            <label for="familyId">Family ID:</label>
            <input
              type="text"
              id="familyId"
              placeholder="Enter Family ID (e.g., family_abc123)"
            />
          </div>
          <div class="form-group">
            <label for="userName">Your Name:</label>
            <input type="text" id="userName" placeholder="Enter your name" />
          </div>
          <div class="form-group">
            <label for="password">Family Password:</label>
            <input
              type="password"
              id="password"
              placeholder="Enter family password"
            />
          </div>
          <button class="btn" onclick="joinFamily()">
            Join Existing Family
          </button>
          <button class="btn btn-secondary" onclick="createFamily()">
            Create New Family
          </button>
          <div id="errorMessage" class="error hidden"></div>
          <div id="successMessage" class="success hidden"></div>
        </div>
      </div>

      <!-- Main Dashboard -->
      <div id="dashboard" class="card hidden">
        <h2>Family Dashboard</h2>
        <div id="familyIdDisplay" class="storage-notice" style="margin-bottom: 20px;">
          <!-- Family ID will be displayed here -->
        </div>

        <div id="locationStatus">
          <div class="permission-section">
            <h3>Location Sharing Permission</h3>
            <p class="permission-text">
              To keep your family safe, we need permission to access your
              location. This allows family members to see where you are and
              helps in emergency situations.
            </p>
            <button class="btn btn-success" onclick="startLocationSharing()">
              Enable Location Sharing
            </button>
          </div>
        </div>

        <div class="family-members" id="familyMembers">
          <!-- Family members will be populated here -->
        </div>

        <button
          class="btn btn-danger"
          onclick="leaveFamily()"
          style="margin-top: 20px"
        >
          Leave Family Network
        </button>
      </div>
    </div>

    <script>
      console.log("[Family Safety] App initialized");

      // GitHub API configuration for anonymous gist storage
      const GITHUB_API_BASE = 'https://api.github.com';
      
      let currentUser = null;
      let currentFamily = null;
      let currentFamilyData = null;
      let isLocationSharing = false;
      let watchId = null;
      let leafletMaps = {};
      let syncInterval = null;

      // Generate a unique family ID
      function generateFamilyId() {
        const timestamp = Date.now().toString(36);
        const randomPart = Math.random().toString(36).substring(2, 8);
        return `family_${timestamp}_${randomPart}`;
      }

      // Create family data structure
      function createFamilyData(familyId, password, creatorName) {
        return {
          familyId: familyId,
          password: password,
          createdAt: new Date().toISOString(),
          lastUpdated: new Date().toISOString(),
          members: [{
            id: Date.now(),
            name: creatorName,
            isOnline: true,
            location: null,
            joinedAt: new Date().toISOString(),
            lastSeen: new Date().toISOString()
          }]
        };
      }

      // Save family data to GitHub Gist
      async function saveFamilyData(familyData) {
        try {
          const gistData = {
            description: `Family Safety Data - ${familyData.familyId}`,
            public: false,
            files: {
              "family-data.json": {
                content: JSON.stringify(familyData, null, 2)
              }
            }
          };

          let response;
          if (familyData.gistId) {
            // Update existing gist
            response = await fetch(`${GITHUB_API_BASE}/gists/${familyData.gistId}`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(gistData)
            });
          } else {
            // Create new gist
            response = await fetch(`${GITHUB_API_BASE}/gists`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(gistData)
            });
          }

          if (!response.ok) {
            throw new Error(`GitHub API error: ${response.status}`);
          }

          const result = await response.json();
          familyData.gistId = result.id;
          familyData.lastUpdated = new Date().toISOString();
          
          return result;
        } catch (error) {
          console.error('[Family Safety] Error saving family data:', error);
          // Fallback to localStorage for demo purposes
          const storageKey = `family_${familyData.familyId}`;
          const dataToStore = JSON.stringify(familyData);
          localStorage.setItem(storageKey, dataToStore);
          return familyData;
        }
      }

      // Load family data from GitHub Gist or localStorage
      async function loadFamilyData(familyId) {
        try {
          // First try to load from localStorage to get gistId
          const storageKey = `family_${familyId}`;
          const localData = localStorage.getItem(storageKey);
          
          if (localData) {
            const parsedData = JSON.parse(localData);
            if (parsedData.gistId) {
              // Try to fetch from GitHub
              const response = await fetch(`${GITHUB_API_BASE}/gists/${parsedData.gistId}`);
              if (response.ok) {
                const gistData = await response.json();
                const familyData = JSON.parse(gistData.files['family-data.json'].content);
                
                // Update localStorage with latest data
                localStorage.setItem(storageKey, JSON.stringify(familyData));
                return familyData;
              }
            }
            return parsedData;
          }
          
          return null;
        } catch (error) {
          console.error('[Family Safety] Error loading family data:', error);
          
          // Fallback to localStorage only
          const storageKey = `family_${familyId}`;
          const localData = localStorage.getItem(storageKey);
          return localData ? JSON.parse(localData) : null;
        }
      }

      // Initialize app
      async function initializeApp() {
        console.log("[Family Safety] Initializing app");

        // Check for saved session
        const savedSession = JSON.parse(localStorage.getItem("familySafetySession") || "{}");
        if (savedSession.currentFamily) {
          try {
            currentFamilyData = await loadFamilyData(savedSession.currentFamily);
            if (currentFamilyData) {
              currentUser = savedSession.currentUser;
              currentFamily = savedSession.currentFamily;
              isLocationSharing = savedSession.isLocationSharing || false;

              // Hide login section and show dashboard
              document.getElementById("loginSection").classList.add("hidden");
              document.getElementById("dashboard").classList.remove("hidden");

              // Show family ID
              displayFamilyId();

              // Restore location sharing if it was active
              if (isLocationSharing) {
                startLocationSharing();
              }

              updateFamilyMembers();
              startSync();
            }
          } catch (error) {
            console.error("[Family Safety] Error restoring session:", error);
            localStorage.removeItem("familySafetySession");
          }
        }
      }

      // Save session to localStorage
      function saveSession() {
        const session = {
          currentUser,
          currentFamily,
          isLocationSharing,
        };
        localStorage.setItem("familySafetySession", JSON.stringify(session));
        console.log("[Family Safety] Session saved");
      }

      // Display family ID
      function displayFamilyId() {
        if (currentFamily) {
          document.getElementById("familyIdDisplay").innerHTML = `
            <h3>👨‍👩‍👧‍👦 Family ID: <code style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">${currentFamily}</code></h3>
            <p>Share this Family ID and password with other family members so they can join from their devices.</p>
          `;
        }
      }

      // Join family function
      async function joinFamily() {
        const familyId = document.getElementById("familyId").value.trim();
        const password = document.getElementById("password").value;
        const userName = document.getElementById("userName").value.trim();

        console.log("[Family Safety] Attempting to join family:", familyId);

        if (!familyId || !password || !userName) {
          showError("Please fill in all fields");
          return;
        }

        try {
          const familyData = await loadFamilyData(familyId);
          
          if (!familyData) {
            showError("Family not found. Please check the Family ID.");
            return;
          }

          if (familyData.password !== password) {
            showError("Incorrect password");
            return;
          }

          // Set current user and family
          currentUser = {
            name: userName,
            isOnline: true,
            location: null,
          };
          currentFamily = familyId;
          currentFamilyData = familyData;

          // Add user to family if not already present
          const existingUser = familyData.members.find((m) => m.name === userName);
          if (!existingUser) {
            familyData.members.push({
              id: Date.now(),
              ...currentUser,
              joinedAt: new Date().toISOString(),
              lastSeen: new Date().toISOString()
            });
            
            // Save updated family data
            await saveFamilyData(familyData);
          } else {
            // Update existing user status
            existingUser.isOnline = true;
            existingUser.lastSeen = new Date().toISOString();
            await saveFamilyData(familyData);
          }

          // Save session
          saveSession();

          // Hide login and show dashboard
          document.getElementById("loginSection").classList.add("hidden");
          document.getElementById("dashboard").classList.remove("hidden");

          displayFamilyId();
          showSuccess("Successfully joined family!");
          updateFamilyMembers();
          startSync();

          console.log("[Family Safety] Successfully joined family");
        } catch (error) {
          console.error("[Family Safety] Error joining family:", error);
          showError("Error joining family. Please try again.");
        }
      }

      // Create new family function
      async function createFamily() {
        const familyIdInput = document.getElementById("familyId").value.trim();
        const password = document.getElementById("password").value;
        const userName = document.getElementById("userName").value.trim();

        console.log("[Family Safety] Attempting to create family");

        if (!password || !userName) {
          showError("Please enter your name and a family password");
          return;
        }

        if (password.length < 6) {
          showError("Password must be at least 6 characters long");
          return;
        }

        try {
          // Generate a unique family ID
          const familyId = familyIdInput || generateFamilyId();
          
          // Check if family already exists (if custom ID provided)
          if (familyIdInput) {
            const existingFamily = await loadFamilyData(familyId);
            if (existingFamily) {
              showError("Family ID already exists. Please choose a different ID or leave blank for auto-generation.");
              return;
            }
          }

          // Create new family data
          const familyData = createFamilyData(familyId, password, userName);

          // Save family data
          await saveFamilyData(familyData);

          // Set current state
          currentUser = familyData.members[0];
          currentFamily = familyId;
          currentFamilyData = familyData;

          // Save session
          saveSession();

          // Hide login and show dashboard
          document.getElementById("loginSection").classList.add("hidden");
          document.getElementById("dashboard").classList.remove("hidden");

          displayFamilyId();
          showSuccess(`Family created successfully! Family ID: ${familyId}`);
          updateFamilyMembers();
          startSync();

          console.log("[Family Safety] Successfully created family");
        } catch (error) {
          console.error("[Family Safety] Error creating family:", error);
          showError("Error creating family. Please try again.");
        }
      }

      // Start syncing with other devices
      function startSync() {
        if (syncInterval) clearInterval(syncInterval);
        
        syncInterval = setInterval(async () => {
          if (currentFamily && currentFamilyData) {
            try {
              // Update current user's status
              const userIndex = currentFamilyData.members.findIndex(m => m.name === currentUser.name);
              if (userIndex !== -1) {
                currentFamilyData.members[userIndex].lastSeen = new Date().toISOString();
                currentFamilyData.members[userIndex].isOnline = true;
                if (currentUser.location) {
                  currentFamilyData.members[userIndex].location = currentUser.location;
                }
              }

              // Fetch latest data from other devices
              const latestData = await loadFamilyData(currentFamily);
              if (latestData && latestData.lastUpdated > currentFamilyData.lastUpdated) {
                currentFamilyData = latestData;
                
                // Find current user in updated data
                const updatedUser = currentFamilyData.members.find(m => m.name === currentUser.name);
                if (updatedUser) {
                  currentUser = updatedUser;
                }
                
                updateFamilyMembers();
              }

              // Save current data
              await saveFamilyData(currentFamilyData);
            } catch (error) {
              console.error("[Family Safety] Sync error:", error);
            }
          }
        }, 10000); // Sync every 10 seconds
      }

      // Start location sharing
      function startLocationSharing() {
        console.log("[Family Safety] Starting location sharing");

        if (!navigator.geolocation) {
          showError("Geolocation is not supported by this browser");
          return;
        }

        const options = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000,
        };

        watchId = navigator.geolocation.watchPosition(
          async (position) => {
            console.log("[Family Safety] Location updated:", position.coords);

            const location = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              address: `${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`,
              timestamp: new Date().toISOString(),
            };

            // Update current user location
            currentUser.location = location;
            isLocationSharing = true;

            // Update in family data
            if (currentFamilyData) {
              const userIndex = currentFamilyData.members.findIndex(m => m.name === currentUser.name);
              if (userIndex !== -1) {
                currentFamilyData.members[userIndex].location = location;
                currentFamilyData.members[userIndex].isOnline = true;
                currentFamilyData.members[userIndex].lastSeen = new Date().toISOString();
              }
              
              await saveFamilyData(currentFamilyData);
            }

            // Save session
            saveSession();

            updateLocationSharingStatus();
            updateFamilyMembers();
          },
          (error) => {
            console.error("[Family Safety] Geolocation error:", error);
            showError("Unable to get your location: " + error.message);
          },
          options
        );
      }

      // Stop location sharing
      async function stopLocationSharing() {
        console.log("[Family Safety] Stopping location sharing");

        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }

        isLocationSharing = false;
        currentUser.location = null;

        // Update in family data
        if (currentFamilyData) {
          const userIndex = currentFamilyData.members.findIndex(m => m.name === currentUser.name);
          if (userIndex !== -1) {
            currentFamilyData.members[userIndex].location = null;
            currentFamilyData.members[userIndex].lastSeen = new Date().toISOString();
          }
          
          await saveFamilyData(currentFamilyData);
        }

        // Save session
        saveSession();

        updateLocationSharingStatus();
        updateFamilyMembers();
      }

      // Update location sharing status
      function updateLocationSharingStatus() {
        const statusDiv = document.getElementById("locationStatus");
        if (isLocationSharing) {
          statusDiv.innerHTML = `
            <div class="location-sharing-status sharing-active">
              <strong style="color: #34d399;">Location sharing is active</strong><br>
              Your family can see your location and you can see theirs.
              <button class="btn btn-secondary" onclick="stopLocationSharing()" style="margin-top: 10px; width: auto; padding: 8px 16px;">Stop Sharing</button>
            </div>
          `;
        } else {
          statusDiv.innerHTML = `
            <div class="permission-section">
              <h3>Location Sharing Permission</h3>
              <p class="permission-text">
                To keep your family safe, we need permission to access your location. 
                This allows family members to see where you are and helps in emergency situations.
              </p>
              <button class="btn btn-success" onclick="startLocationSharing()">Enable Location Sharing</button>
            </div>
          `;
        }
      }

      // Update family members display
      function updateFamilyMembers() {
        console.log("[Family Safety] Updating family members display");

        if (!currentFamilyData) return;

        const membersContainer = document.getElementById("familyMembers");

        // Clean up existing maps
        Object.values(leafletMaps).forEach((map) => {
          if (map) {
            map.remove();
          }
        });
        leafletMaps = {};

        let membersHTML = "";
        currentFamilyData.members.forEach((member) => {
          const isCurrentUser = member.name === currentUser.name;
          const cardClass = isCurrentUser ? "member-card your-info" : "member-card";
          
          // Check if user was recently active (within 2 minutes)
          const lastSeen = new Date(member.lastSeen || member.joinedAt);
          const isRecentlyActive = (Date); }
        }