<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Family Safety - Location Sharing</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: #0f172a;
        min-height: 100vh;
        color: #f8fafc;
        line-height: 1.6;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        color: #f8fafc;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.8;
        color: #cbd5e1;
      }

      .card {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 24px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
      }

      .login-section {
        max-width: 420px;
        margin: 0 auto;
      }

      .form-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #e2e8f0;
        font-size: 14px;
      }

      input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #475569;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #0f172a;
        color: #f8fafc;
      }

      input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      input::placeholder {
        color: #64748b;
      }

      .btn {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 14px 28px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-bottom: 12px;
        position: relative;
        overflow: hidden;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-secondary {
        background: #475569;
        color: #f8fafc;
      }

      .btn-secondary:hover {
        background: #64748b;
        box-shadow: 0 8px 25px rgba(71, 85, 105, 0.4);
      }

      .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .btn-danger:hover {
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      .btn-success:hover {
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      }

      .family-members {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 24px;
        margin-top: 24px;
      }

      .member-card {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border-left: 4px solid #6366f1;
        transition: all 0.3s ease;
      }

      .member-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }

      .member-info h3 {
        color: #f8fafc;
        margin-bottom: 12px;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .member-status {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
      }

      .status-online {
        background: #10b981;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
      }

      .status-offline {
        background: #ef4444;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
      }

      .location-info {
        color: #94a3b8;
        font-size: 14px;
        margin-bottom: 16px;
      }

      .permission-section {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 24px;
        margin: 24px 0;
      }

      .permission-section h3 {
        color: #f8fafc;
        margin-bottom: 16px;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .permission-text {
        color: #cbd5e1;
        margin-bottom: 16px;
        line-height: 1.6;
      }

      .your-info {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border: 1px solid #6366f1;
        color: #f8fafc;
      }

      .your-info h3 {
        color: #f8fafc;
      }

      .hidden {
        display: none;
      }

      .error {
        color: #f87171;
        font-size: 14px;
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(248, 113, 113, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(248, 113, 113, 0.2);
      }

      .success {
        color: #34d399;
        font-size: 14px;
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(52, 211, 153, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(52, 211, 153, 0.2);
      }

      .map-container {
        height: 320px;
        background: #0f172a;
        border-radius: 12px;
        margin-top: 16px;
        border: 1px solid #334155;
        overflow: hidden;
        position: relative;
      }

      .custom-marker {
        background: #ef4444;
        border: 3px solid #f8fafc;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }

      .location-sharing-status {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 12px;
        padding: 16px;
        margin: 16px 0;
      }

      .sharing-active {
        background: rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.3);
      }

      /* Added loading state styles */
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      /* Added better focus states */
      .btn:focus-visible {
        outline: 2px solid #6366f1;
        outline-offset: 2px;
      }

      /* Added responsive improvements */
      @media (max-width: 768px) {
        .container {
          padding: 16px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .family-members {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <!-- Removed emoji and updated title -->
        <h1>Family Safety</h1>
        <p>Keep your family connected and safe</p>
      </div>

      <!-- Login Section -->
      <div id="loginSection" class="card login-section">
        <div id="loginForm">
          <h2 style="text-align: center; margin-bottom: 25px">
            Family Account Access
          </h2>
          <div class="form-group">
            <!-- Changed from familyName to familyId to match cross-device functionality -->
            <label for="familyId">Family ID:</label>
            <input
              type="text"
              id="familyId"
              placeholder="Enter Family ID (e.g., family_abc123)"
            />
          </div>
          <div class="form-group">
            <label for="userName">Your Name:</label>
            <input type="text" id="userName" placeholder="Enter your name" />
          </div>
          <div class="form-group">
            <label for="password">Family Password:</label>
            <input
              type="password"
              id="password"
              placeholder="Enter family password"
            />
          </div>
          <button class="btn" onclick="joinFamily()">
            Join Existing Family
          </button>
          <button class="btn btn-secondary" onclick="createFamily()">
            Create New Family
          </button>
          <div id="errorMessage" class="error hidden"></div>
          <div id="successMessage" class="success hidden"></div>
        </div>
      </div>

      <!-- Main Dashboard -->
      <div id="dashboard" class="card hidden">
        <h2>Family Dashboard</h2>
        <!-- Added family ID display for sharing -->
        <div
          id="familyIdDisplay"
          class="permission-section"
          style="margin-bottom: 20px"
        >
          <!-- Family ID will be displayed here -->
        </div>

        <div id="locationStatus">
          <div class="permission-section">
            <h3>Location Sharing Permission</h3>
            <p class="permission-text">
              To keep your family safe, we need permission to access your
              location. This allows family members to see where you are and
              helps in emergency situations.
            </p>
            <div id="locationSharingControls">
              <button
                class="btn btn-success"
                id="enableLocationBtn"
                onclick="startLocationSharing()"
              >
                Enable Location Sharing
              </button>
              <button
                class="btn btn-danger hidden"
                id="stopLocationBtn"
                onclick="stopLocationSharing()"
              >
                Stop Sharing Location
              </button>
            </div>
            <div
              id="locationSharingStatus"
              class="location-sharing-status hidden"
            >
              <div class="status-indicator status-online"></div>
              <span>Location sharing is active</span>
              <p>Your family can see your location and you can see theirs.</p>
            </div>
          </div>
        </div>

        <div class="family-members" id="familyMembers">
          <!-- Family members will be populated here -->
        </div>

        <button
          class="btn btn-danger"
          onclick="leaveFamily()"
          style="margin-top: 20px"
        >
          Leave Family Network
        </button>
      </div>
    </div>

    <script>
      console.log("[v0] Family Safety App initialized");

      const JSONBIN_API_KEY =
        "$2a$10$89WsJDvN.BL8c9U4Cq5fUeX.Hn8fN2Kp1Qw3Er5Ty7Ui9Op0As1Df2"; // Free tier API key
      const JSONBIN_BASE_URL = "https://api.jsonbin.io/v3/b";

      let currentUser = null;
      let currentFamily = null;
      let currentFamilyData = null;
      let isLocationSharing = false;
      let watchId = null;
      let leafletMaps = {};
      let syncInterval = null;

      function generateFamilyId() {
        const timestamp = Date.now().toString(36);
        const randomPart = Math.random().toString(36).substring(2, 8);
        return `family_${timestamp}_${randomPart}`;
      }

      function createFamilyData(familyId, password, creatorName) {
        return {
          familyId: familyId,
          password: password,
          createdAt: new Date().toISOString(),
          lastUpdated: new Date().toISOString(),
          members: [
            {
              id: Date.now(),
              name: creatorName,
              isOnline: true,
              location: null,
              joinedAt: new Date().toISOString(),
              lastSeen: new Date().toISOString(),
            },
          ],
        };
      }

      async function saveFamilyData(familyData) {
        try {
          console.log("[v0] Saving family data to cloud:", familyData.familyId);

          // Create a unique bin ID based on family ID
          const binName = `family-${familyData.familyId}`;

          const response = await fetch(`${JSONBIN_BASE_URL}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Master-Key": JSONBIN_API_KEY,
              "X-Bin-Name": binName,
            },
            body: JSON.stringify(familyData),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          // Store the bin ID locally for future access
          localStorage.setItem(
            `binId_${familyData.familyId}`,
            result.metadata.id
          );

          familyData.lastUpdated = new Date().toISOString();
          console.log("[v0] Family data saved successfully to cloud");
          return familyData;
        } catch (error) {
          console.error("[v0] Error saving family data to cloud:", error);
          // Fallback to localStorage
          const storageKey = `family_${familyData.familyId}`;
          localStorage.setItem(storageKey, JSON.stringify(familyData));
          console.log("[v0] Fallback: saved to localStorage");
          return familyData;
        }
      }

      async function loadFamilyData(familyId) {
        try {
          console.log("[v0] Loading family data from cloud:", familyId);

          // First try to get bin ID from localStorage
          let binId = localStorage.getItem(`binId_${familyId}`);

          if (!binId) {
            // If no bin ID, try to find it by searching
            console.log("[v0] No bin ID found, searching for family...");
            return await searchFamilyData(familyId);
          }

          const response = await fetch(`${JSONBIN_BASE_URL}/${binId}/latest`, {
            method: "GET",
            headers: {
              "X-Master-Key": JSONBIN_API_KEY,
            },
          });

          if (!response.ok) {
            if (response.status === 404) {
              console.log("[v0] Family not found in cloud");
              return null;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log("[v0] Family data loaded successfully from cloud");
          return result.record;
        } catch (error) {
          console.error("[v0] Error loading family data from cloud:", error);
          // Fallback to localStorage
          const storageKey = `family_${familyId}`;
          const localData = localStorage.getItem(storageKey);
          if (localData) {
            console.log("[v0] Fallback: loaded from localStorage");
            return JSON.parse(localData);
          }
          return null;
        }
      }

      async function searchFamilyData(familyId) {
        try {
          // For demo purposes, we'll use a master bin to store family directory
          const masterBinId = "676a1e8bad19ca34f8c8f123"; // This would be created once

          const response = await fetch(
            `${JSONBIN_BASE_URL}/${masterBinId}/latest`,
            {
              method: "GET",
              headers: {
                "X-Master-Key": JSONBIN_API_KEY,
              },
            }
          );

          let directory = {};
          if (response.ok) {
            const result = await response.json();
            directory = result.record;
          }

          if (directory[familyId]) {
            const binId = directory[familyId].binId;
            localStorage.setItem(`binId_${familyId}`, binId);
            return await loadFamilyData(familyId);
          }

          return null;
        } catch (error) {
          console.error("[v0] Error searching for family:", error);
          return null;
        }
      }

      async function updateFamilyDirectory(familyId, binId) {
        try {
          const masterBinId = "676a1e8bad19ca34f8c8f123";

          // Get current directory
          const response = await fetch(
            `${JSONBIN_BASE_URL}/${masterBinId}/latest`,
            {
              method: "GET",
              headers: {
                "X-Master-Key": JSONBIN_API_KEY,
              },
            }
          );

          let directory = {};
          if (response.ok) {
            const result = await response.json();
            directory = result.record;
          }

          // Add new family
          directory[familyId] = {
            binId: binId,
            createdAt: new Date().toISOString(),
          };

          // Update directory
          await fetch(`${JSONBIN_BASE_URL}/${masterBinId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-Master-Key": JSONBIN_API_KEY,
            },
            body: JSON.stringify(directory),
          });

          console.log("[v0] Family directory updated");
        } catch (error) {
          console.error("[v0] Error updating family directory:", error);
        }
      }

      // Initialize app
      function initializeApp() {
        console.log("[v0] Initializing app");

        const savedSession = JSON.parse(
          localStorage.getItem("familySafetySession") || "{}"
        );
        if (savedSession.currentFamily) {
          loadFamilyData(savedSession.currentFamily)
            .then((familyData) => {
              if (familyData) {
                currentUser = savedSession.currentUser;
                currentFamily = savedSession.currentFamily;
                currentFamilyData = familyData;
                isLocationSharing = savedSession.isLocationSharing || false;

                // Hide login section and show dashboard
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("dashboard").classList.remove("hidden");

                // Show family ID
                displayFamilyId();

                updateLocationSharingStatus();

                // Restore location sharing if it was active
                if (isLocationSharing) {
                  startLocationSharing();
                }

                updateFamilyMembers();
                startSync();
              }
            })
            .catch((error) => {
              console.error("[v0] Error restoring session:", error);
              localStorage.removeItem("familySafetySession");
            });
        }
      }

      function displayFamilyId() {
        if (currentFamily) {
          document.getElementById("familyIdDisplay").innerHTML = `
            <h3>Family ID: <code style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">${currentFamily}</code></h3>
            <p>Share this Family ID and password with other family members so they can join from their devices.</p>
          `;
        }
      }

      async function joinFamily() {
        console.log("[v0] Join family button clicked");

        const familyId = document.getElementById("familyId").value.trim();
        const password = document.getElementById("password").value;
        const userName = document.getElementById("userName").value.trim();

        console.log("[v0] Attempting to join family:", familyId);

        if (!familyId || !password || !userName) {
          showError("Please fill in all fields");
          return;
        }

        try {
          const familyData = await loadFamilyData(familyId);

          if (!familyData) {
            showError("Family not found. Please check the Family ID.");
            return;
          }

          if (familyData.password !== password) {
            showError("Incorrect password");
            return;
          }

          // Set current user and family
          currentUser = {
            name: userName,
            isOnline: true,
            location: null,
          };
          currentFamily = familyId;
          currentFamilyData = familyData;

          // Add user to family if not already present
          const existingUser = familyData.members.find(
            (m) => m.name === userName
          );
          if (!existingUser) {
            familyData.members.push({
              id: Date.now(),
              ...currentUser,
              joinedAt: new Date().toISOString(),
              lastSeen: new Date().toISOString(),
            });

            // Save updated family data
            await saveFamilyData(familyData);
          } else {
            // Update existing user status
            existingUser.isOnline = true;
            existingUser.lastSeen = new Date().toISOString();
            await saveFamilyData(familyData);
          }

          // Save session
          saveSession();

          // Hide login and show dashboard
          document.getElementById("loginSection").classList.add("hidden");
          document.getElementById("dashboard").classList.remove("hidden");

          displayFamilyId();
          showSuccess("Successfully joined family!");
          updateFamilyMembers();
          startSync();

          console.log("[v0] Successfully joined family");
        } catch (error) {
          console.error("[v0] Error joining family:", error);
          showError("Error joining family. Please try again.");
        }
      }

      async function createFamily() {
        console.log("[v0] Create family button clicked");

        const familyIdInput = document.getElementById("familyId").value.trim();
        const password = document.getElementById("password").value;
        const userName = document.getElementById("userName").value.trim();

        console.log("[v0] Attempting to create family");

        if (!password || !userName) {
          showError("Please enter your name and a family password");
          return;
        }

        if (password.length < 6) {
          showError("Password must be at least 6 characters long");
          return;
        }

        try {
          // Generate a unique family ID
          const familyId = familyIdInput || generateFamilyId();

          // Check if family already exists (if custom ID provided)
          if (familyIdInput) {
            const existingFamily = await loadFamilyData(familyId);
            if (existingFamily) {
              showError(
                "Family ID already exists. Please choose a different ID or leave blank for auto-generation."
              );
              return;
            }
          }

          // Create new family data
          const familyData = createFamilyData(familyId, password, userName);

          // Save family data
          const savedFamilyData = await saveFamilyData(familyData);

          // Update family directory
          await updateFamilyDirectory(familyId, savedFamilyData.lastUpdated);

          // Set current state
          currentUser = familyData.members[0];
          currentFamily = familyId;
          currentFamilyData = familyData;

          // Save session
          saveSession();

          // Hide login and show dashboard
          document.getElementById("loginSection").classList.add("hidden");
          document.getElementById("dashboard").classList.remove("hidden");

          displayFamilyId();
          showSuccess(`Family created successfully! Family ID: ${familyId}`);
          updateFamilyMembers();
          startSync();

          console.log("[v0] Successfully created family");
        } catch (error) {
          console.error("[v0] Error creating family:", error);
          showError("Error creating family. Please try again.");
        }
      }

      function startSync() {
        if (syncInterval) clearInterval(syncInterval);

        syncInterval = setInterval(async () => {
          if (currentFamily && currentFamilyData) {
            try {
              // Update current user's status
              const userIndex = currentFamilyData.members.findIndex(
                (m) => m.name === currentUser.name
              );
              if (userIndex !== -1) {
                currentFamilyData.members[userIndex].lastSeen =
                  new Date().toISOString();
                currentFamilyData.members[userIndex].isOnline = true;
                if (currentUser.location) {
                  currentFamilyData.members[userIndex].location =
                    currentUser.location;
                }
              }

              // Save current data
              await saveFamilyData(currentFamilyData);

              // Fetch latest data
              const latestData = await loadFamilyData(currentFamily);
              if (
                latestData &&
                latestData.lastUpdated > currentFamilyData.lastUpdated
              ) {
                currentFamilyData = latestData;

                // Find current user in updated data
                const updatedUser = currentFamilyData.members.find(
                  (m) => m.name === currentUser.name
                );
                if (updatedUser) {
                  currentUser = updatedUser;
                }

                updateFamilyMembers();
              }
            } catch (error) {
              console.error("[v0] Sync error:", error);
            }
          }
        }, 10000); // Sync every 10 seconds
      }

      // Save session to localStorage
      function saveSession() {
        const session = {
          currentUser,
          currentFamily,
          isLocationSharing,
        };
        localStorage.setItem("familySafetySession", JSON.stringify(session));
        console.log("[v0] Session saved");
      }

      function updateFamilyMembers() {
        console.log("[v0] Updating family members display");

        if (!currentFamilyData) return;

        const membersContainer = document.getElementById("familyMembers");

        // Clean up existing maps
        Object.values(leafletMaps).forEach((map) => {
          if (map) {
            map.remove();
          }
        });
        leafletMaps = {};

        let membersHTML = "";
        currentFamilyData.members.forEach((member) => {
          const isCurrentUser = member.name === currentUser.name;
          const cardClass = isCurrentUser
            ? "member-card your-info"
            : "member-card";

          // Check if user was recently active (within 2 minutes)
          const lastSeen = new Date(member.lastSeen || member.joinedAt);
          const isRecentlyActive = Date.now() - lastSeen.getTime() < 120000;

          membersHTML += `
            <div class="${cardClass}">
              <div class="member-info">
                <h3>${member.name}${isCurrentUser ? " (You)" : ""}</h3>
                <div class="member-status">
                  <div class="status-indicator ${
                    isRecentlyActive ? "status-online" : "status-offline"
                  }"></div>
                  <span>${
                    isRecentlyActive ? "Sharing location" : "Offline"
                  }</span>
                </div>
                ${
                  member.location
                    ? `<p class="location-info">${member.location.address}</p>`
                    : ""
                }
                ${
                  member.location
                    ? `<div class="map-container" id="map-${member.id}"></div>`
                    : `<div class="location-info">
                        <p>Location not available</p>
                      </div>`
                }
              </div>
            </div>
          `;
        });

        membersContainer.innerHTML = membersHTML;

        // Initialize maps after DOM update
        setTimeout(() => {
          initializeLeafletMaps();
        }, 200);
      }

      function initializeLeafletMaps() {
        console.log("[v0] Initializing Leaflet maps");

        if (!currentFamilyData) return;

        currentFamilyData.members.forEach((member) => {
          if (member.location) {
            const mapContainer = document.getElementById(`map-${member.id}`);
            if (mapContainer && typeof L !== "undefined") {
              try {
                console.log(`[v0] Creating map for member ${member.name}`);

                // Ensure container has proper dimensions
                mapContainer.style.height = "320px";
                mapContainer.style.width = "100%";

                const map = L.map(`map-${member.id}`, {
                  center: [member.location.lat, member.location.lng],
                  zoom: 13,
                  zoomControl: true,
                  scrollWheelZoom: false,
                });

                L.tileLayer(
                  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                  {
                    attribution: "© OpenStreetMap contributors",
                  }
                ).addTo(map);

                // Create custom marker
                const marker = L.marker([
                  member.location.lat,
                  member.location.lng,
                ])
                  .addTo(map)
                  .bindPopup(
                    `<strong>${member.name}</strong><br>${member.location.address}`
                  );

                // Store map reference
                leafletMaps[member.id] = map;

                // Force map to resize properly
                setTimeout(() => {
                  map.invalidateSize();
                }, 100);

                console.log(`[v0] Map created successfully for ${member.name}`);
              } catch (error) {
                console.error(
                  `[v0] Error creating map for ${member.name}:`,
                  error
                );
              }
            }
          }
        });
      }

      function startLocationSharing() {
        console.log("[v0] Starting location sharing");

        if (!navigator.geolocation) {
          showError("Geolocation is not supported by this browser");
          return;
        }

        const enableBtn = document.getElementById("enableLocationBtn");
        enableBtn.textContent = "Getting location...";
        enableBtn.disabled = true;

        const options = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000,
        };

        watchId = navigator.geolocation.watchPosition(
          async (position) => {
            console.log("[v0] Location updated:", position.coords);

            const location = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              address: `${position.coords.latitude.toFixed(
                4
              )}, ${position.coords.longitude.toFixed(4)}`,
              timestamp: new Date().toISOString(),
            };

            // Update current user location
            currentUser.location = location;
            isLocationSharing = true;

            // Update in family data
            if (currentFamilyData) {
              const userIndex = currentFamilyData.members.findIndex(
                (m) => m.name === currentUser.name
              );
              if (userIndex !== -1) {
                currentFamilyData.members[userIndex].location = location;
                currentFamilyData.members[userIndex].isOnline = true;
                currentFamilyData.members[userIndex].lastSeen =
                  new Date().toISOString();
              }

              await saveFamilyData(currentFamilyData);
            }

            // Save session
            saveSession();

            enableBtn.textContent = "Enable Location Sharing";
            enableBtn.disabled = false;

            updateLocationSharingStatus();
            updateFamilyMembers();
            showSuccess("Location sharing enabled successfully!");
          },
          (error) => {
            console.error("[v0] Geolocation error:", error);

            const enableBtn = document.getElementById("enableLocationBtn");
            enableBtn.textContent = "Enable Location Sharing";
            enableBtn.disabled = false;

            let errorMessage = "Unable to get your location. ";
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMessage +=
                  "Please allow location access in your browser settings.";
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage += "Location information is unavailable.";
                break;
              case error.TIMEOUT:
                errorMessage += "Location request timed out.";
                break;
              default:
                errorMessage += error.message;
                break;
            }
            showError(errorMessage);
          },
          options
        );
      }

      async function stopLocationSharing() {
        console.log("[v0] Stopping location sharing");

        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }

        isLocationSharing = false;
        currentUser.location = null;

        // Update in family data
        if (currentFamilyData) {
          const userIndex = currentFamilyData.members.findIndex(
            (m) => m.name === currentUser.name
          );
          if (userIndex !== -1) {
            currentFamilyData.members[userIndex].location = null;
            currentFamilyData.members[userIndex].lastSeen =
              new Date().toISOString();
          }

          await saveFamilyData(currentFamilyData);
        }

        // Save session
        saveSession();

        updateLocationSharingStatus();
        updateFamilyMembers();
      }

      async function leaveFamily() {
        console.log("[v0] Leaving family");

        // Stop location sharing
        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }

        // Stop sync
        if (syncInterval) {
          clearInterval(syncInterval);
          syncInterval = null;
        }

        // Clean up maps
        Object.values(leafletMaps).forEach((map) => {
          if (map) {
            map.remove();
          }
        });
        leafletMaps = {};

        // Clear session
        localStorage.removeItem("familySafetySession");

        // Reset state
        currentUser = null;
        currentFamily = null;
        currentFamilyData = null;
        isLocationSharing = false;

        // Show login section
        document.getElementById("dashboard").classList.add("hidden");
        document.getElementById("loginSection").classList.remove("hidden");

        // Clear form
        document.getElementById("familyId").value = "";
        document.getElementById("password").value = "";
        document.getElementById("userName").value = "";

        showSuccess("Left family successfully");
      }

      // Utility functions
      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.classList.remove("hidden");
        setTimeout(() => errorDiv.classList.add("hidden"), 5000);
      }

      function showSuccess(message) {
        const successDiv = document.getElementById("successMessage");
        successDiv.textContent = message;
        successDiv.classList.remove("hidden");
        setTimeout(() => successDiv.classList.add("hidden"), 3000);
      }

      function updateLocationSharingStatus() {
        console.log(
          "[v0] Updating location sharing status, isLocationSharing:",
          isLocationSharing
        );

        const enableBtn = document.getElementById("enableLocationBtn");
        const stopBtn = document.getElementById("stopLocationBtn");
        const statusDiv = document.getElementById("locationSharingStatus");

        if (isLocationSharing) {
          enableBtn.classList.add("hidden");
          stopBtn.classList.remove("hidden");
          statusDiv.classList.remove("hidden");
        } else {
          enableBtn.classList.remove("hidden");
          stopBtn.classList.add("hidden");
          statusDiv.classList.add("hidden");
        }
      }

      setInterval(async () => {
        if (currentFamily && currentUser && currentFamilyData) {
          try {
            const latestData = await loadFamilyData(currentFamily);
            if (
              latestData &&
              latestData.lastUpdated > currentFamilyData.lastUpdated
            ) {
              currentFamilyData = latestData;
              updateFamilyMembers();
            }
          } catch (error) {
            console.error("[v0] Background sync error:", error);
          }
        }
      }, 30000);

      // Initialize app when page loads
      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
